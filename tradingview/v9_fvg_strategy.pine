// V9 ICT FVG Strategy with Alerts
// @version=5
indicator("V9 ICT FVG Strategy", overlay=true, max_boxes_count=500, max_labels_count=500)

// ============================================================================
// INPUTS
// ============================================================================
// Symbol Settings
i_minRiskES = input.float(1.5, "Min Risk ES (pts)", minval=0.5, step=0.5, group="Risk Filter")
i_minRiskNQ = input.float(6.0, "Min Risk NQ (pts)", minval=1.0, step=0.5, group="Risk Filter")
i_minFVGTicks = input.int(5, "Min FVG Size (ticks)", minval=1, group="FVG Settings")
i_tickSize = input.float(0.25, "Tick Size", minval=0.01, step=0.25, group="FVG Settings")

// Filter Settings
i_useEMAFilter = input.bool(true, "Use EMA Filter", group="Filters")
i_emaFast = input.int(20, "EMA Fast", minval=5, group="Filters")
i_emaSlow = input.int(50, "EMA Slow", minval=10, group="Filters")
i_useADXFilter = input.bool(true, "Use ADX Filter", group="Filters")
i_adxThreshold = input.int(17, "ADX Threshold", minval=10, group="Filters")
i_adxLength = input.int(14, "ADX Length", minval=5, group="Filters")
i_useDisplacement = input.bool(true, "Use Displacement Filter", group="Filters")
i_dispMultiplier = input.float(1.0, "Displacement Multiplier", minval=0.5, step=0.1, group="Filters")

// Visual Settings
i_showFVG = input.bool(true, "Show FVG Boxes", group="Visuals")
i_showSignals = input.bool(true, "Show Entry Signals", group="Visuals")
i_bullColor = input.color(color.new(color.green, 70), "Bullish FVG Color", group="Visuals")
i_bearColor = input.color(color.new(color.red, 70), "Bearish FVG Color", group="Visuals")

// Alert Settings
i_alertOnSignal = input.bool(true, "Enable Alerts", group="Alerts")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Determine symbol and min risk
isES = str.contains(syminfo.ticker, "ES")
isNQ = str.contains(syminfo.ticker, "NQ")
minRiskPts = isES ? i_minRiskES : isNQ ? i_minRiskNQ : i_minRiskES

// EMA Calculations
emaFast = ta.ema(close, i_emaFast)
emaSlow = ta.ema(close, i_emaSlow)

// ADX Calculations
[diPlus, diMinus, adx] = ta.dmi(i_adxLength, i_adxLength)

// Average body size for displacement
avgBody = ta.sma(math.abs(close - open), 20)
dispThreshold = avgBody * i_dispMultiplier

// Current bar body size
bodySize = math.abs(close - open)
isDisplacement = bodySize > dispThreshold

// ============================================================================
// FVG DETECTION
// ============================================================================

// Bullish FVG: Bar[2].high < Bar[0].low (gap up)
bullishFVG = low > high[2]
bullishFVG_low = high[2]
bullishFVG_high = low
bullishFVG_size = (bullishFVG_high - bullishFVG_low) / i_tickSize

// Bearish FVG: Bar[2].low > Bar[0].high (gap down)
bearishFVG = high < low[2]
bearishFVG_high = low[2]
bearishFVG_low = high
bearishFVG_size = (bearishFVG_high - bearishFVG_low) / i_tickSize

// ============================================================================
// FILTER CHECKS
// ============================================================================

// EMA Filter
emaLongOK = not i_useEMAFilter or emaFast > emaSlow
emaShortOK = not i_useEMAFilter or emaFast < emaSlow

// ADX Filter
adxOK = not i_useADXFilter or adx > i_adxThreshold

// DI Direction Filter
diLongOK = not i_useADXFilter or diPlus > diMinus
diShortOK = not i_useADXFilter or diMinus > diPlus

// Displacement Filter (check bar that created FVG, which is bar[1])
dispLongOK = not i_useDisplacement or (math.abs(close[1] - open[1]) > dispThreshold)
dispShortOK = not i_useDisplacement or (math.abs(close[1] - open[1]) > dispThreshold)

// Min FVG Size Filter
minSizeOK_bull = bullishFVG_size >= i_minFVGTicks
minSizeOK_bear = bearishFVG_size >= i_minFVGTicks

// Min Risk Filter
bullishRisk = (bullishFVG_high + bullishFVG_low) / 2 - bullishFVG_low + (2 * i_tickSize)
bearishRisk = bearishFVG_high - (bearishFVG_high + bearishFVG_low) / 2 + (2 * i_tickSize)
minRiskOK_bull = bullishRisk >= minRiskPts
minRiskOK_bear = bearishRisk >= minRiskPts

// ============================================================================
// VALID SIGNALS
// ============================================================================

validBullishFVG = bullishFVG and minSizeOK_bull and minRiskOK_bull and emaLongOK and adxOK and diLongOK and dispLongOK
validBearishFVG = bearishFVG and minSizeOK_bear and minRiskOK_bear and emaShortOK and adxOK and diShortOK and dispShortOK

// ============================================================================
// VISUALS
// ============================================================================

// Draw FVG boxes
if i_showFVG and validBullishFVG
    box.new(bar_index - 2, bullishFVG_high, bar_index + 10, bullishFVG_low,
            border_color=color.green, bgcolor=i_bullColor, border_width=2)

if i_showFVG and validBearishFVG
    box.new(bar_index - 2, bearishFVG_high, bar_index + 10, bearishFVG_low,
            border_color=color.red, bgcolor=i_bearColor, border_width=2)

// Draw entry signals
if i_showSignals and validBullishFVG
    entryPrice = (bullishFVG_high + bullishFVG_low) / 2
    stopPrice = bullishFVG_low - (2 * i_tickSize)
    risk = entryPrice - stopPrice
    target4R = entryPrice + (4 * risk)

    label.new(bar_index, low, "LONG\n" + str.tostring(entryPrice, "#.##") + "\nStop: " + str.tostring(stopPrice, "#.##") + "\nRisk: " + str.tostring(risk, "#.##") + " pts",
              color=color.green, textcolor=color.white, style=label.style_label_up, size=size.small)

if i_showSignals and validBearishFVG
    entryPrice = (bearishFVG_high + bearishFVG_low) / 2
    stopPrice = bearishFVG_high + (2 * i_tickSize)
    risk = stopPrice - entryPrice
    target4R = entryPrice - (4 * risk)

    label.new(bar_index, high, "SHORT\n" + str.tostring(entryPrice, "#.##") + "\nStop: " + str.tostring(stopPrice, "#.##") + "\nRisk: " + str.tostring(risk, "#.##") + " pts",
              color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)

// Plot EMAs
plot(emaFast, "EMA Fast", color=color.blue, linewidth=1)
plot(emaSlow, "EMA Slow", color=color.purple, linewidth=2)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(validBullishFVG, title="V9 LONG Signal", message="V9 LONG: {{ticker}} @ {{close}} - FVG formed with all filters passed")
alertcondition(validBearishFVG, title="V9 SHORT Signal", message="V9 SHORT: {{ticker}} @ {{close}} - FVG formed with all filters passed")
alertcondition(validBullishFVG or validBearishFVG, title="V9 Any Signal", message="V9 {{ticker}}: New FVG signal @ {{close}}")

// ============================================================================
// INFO TABLE
// ============================================================================

var table infoTable = table.new(position.top_right, 2, 10, bgcolor=color.new(color.black, 80))

if barstate.islast
    table.cell(infoTable, 0, 0, "V9 Strategy", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, syminfo.ticker, text_color=color.yellow, text_size=size.small)

    table.cell(infoTable, 0, 1, "Min Risk", text_color=color.white, text_size=size.tiny)
    table.cell(infoTable, 1, 1, str.tostring(minRiskPts) + " pts", text_color=color.white, text_size=size.tiny)

    table.cell(infoTable, 0, 2, "EMA 20/50", text_color=color.white, text_size=size.tiny)
    table.cell(infoTable, 1, 2, emaFast > emaSlow ? "BULLISH" : "BEARISH", text_color=emaFast > emaSlow ? color.green : color.red, text_size=size.tiny)

    table.cell(infoTable, 0, 3, "ADX", text_color=color.white, text_size=size.tiny)
    table.cell(infoTable, 1, 3, str.tostring(adx, "#.#") + (adx > i_adxThreshold ? " OK" : " LOW"), text_color=adx > i_adxThreshold ? color.green : color.red, text_size=size.tiny)

    table.cell(infoTable, 0, 4, "DI Direction", text_color=color.white, text_size=size.tiny)
    table.cell(infoTable, 1, 4, diPlus > diMinus ? "+DI > -DI" : "-DI > +DI", text_color=diPlus > diMinus ? color.green : color.red, text_size=size.tiny)

    table.cell(infoTable, 0, 5, "Bias", text_color=color.white, text_size=size.tiny)
    longBias = emaFast > emaSlow and adx > i_adxThreshold and diPlus > diMinus
    shortBias = emaFast < emaSlow and adx > i_adxThreshold and diMinus > diPlus
    biasText = longBias ? "LONG" : shortBias ? "SHORT" : "NEUTRAL"
    biasColor = longBias ? color.green : shortBias ? color.red : color.gray
    table.cell(infoTable, 1, 5, biasText, text_color=biasColor, text_size=size.tiny)
